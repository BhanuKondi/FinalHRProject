{% extends "admin/admin_base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">Employees</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
        + Add Employee
    </button>
</div>

<!-- ================= EMPLOYEE TABLE ================= -->
<table class="table table-bordered table-striped table-hover" id="employeeTable">
    <thead class="table-light">
        <tr>
            <th>Code</th>
            <th>Name</th>
            <th>Email</th>
            <th>Department</th>
            <th>Join Date</th>
            <th>Status</th>
            <th width="160">Action</th>
        </tr>
    </thead>
    <tbody>
        {% for emp in employees %}
        <tr>
            <td>{{ emp.emp_code }}</td>
            <td>{{ emp.first_name }} {{ emp.last_name }}</td>
            <td>{{ emp.work_email }}</td>
            <td>{{ emp.department }}</td>
            <td>{{ emp.date_of_joining }}</td>
            <td>
                <span class="badge {% if emp.status == 'Active' %}bg-success{% elif emp.status == 'Inactive' %}bg-secondary{% else %}bg-danger{% endif %}">{{ emp.status }}</span>
            </td>
            <td>
                <button class="btn btn-sm btn-info text-white" data-bs-toggle="modal" data-bs-target="#viewEmployeeModal" onclick="openViewEmployee({{ emp.id }})">View</button>
                <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editEmployeeModal" onclick="openEditEmployee({{ emp.id }})">Edit</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- ================= ADD EMPLOYEE MODAL ================= -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <form id="addEmployeeForm" action="/admin/employees/add" method="POST">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">Add Employee</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs mb-3">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#addBasicTab">Basic Details</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#addSalaryTab">Salary</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#addAccountTab">Account</button></li>
          </ul>

          <div class="tab-content">

            <!-- BASIC DETAILS -->
            <div class="tab-pane fade show active" id="addBasicTab">
              <div class="row g-3">
                <div class="col-md-6"><label>Employee Code</label><input name="emp_code" class="form-control" required></div>
                <div class="col-md-6"><label>Email</label><input name="work_email" type="email" class="form-control" required></div>
                <div class="col-md-6"><label>First Name</label><input name="first_name" class="form-control" required></div>
                <div class="col-md-6"><label>Last Name</label><input name="last_name" class="form-control" required></div>
                <div class="col-md-6"><label>Phone</label><input name="phone" class="form-control"></div>
                <div class="col-md-6"><label>Department</label><input name="department" class="form-control"></div>
                <div class="col-md-6"><label>Job Title</label><input name="job_title" class="form-control"></div>
                <div class="col-md-6"><label>Date of Joining</label><input name="date_of_joining" type="date" class="form-control" required></div>
                <div class="col-md-6"><label>Role</label>
                  <select name="role_id" class="form-control">
                    <option value="1">Admin</option>
                    <option value="2">Manager</option>
                    <option value="3">Employee</option>
                  </select>
                </div>
                <div class="col-md-6"><label>Temp Password</label><input name="password" class="form-control" required></div>
              </div>
              <div class="text-end mt-3">
                <button type="button" class="btn btn-primary" onclick="nextTab('addSalaryTab')">Save & Next →</button>
              </div>
            </div>

            <!-- SALARY -->
            <div class="tab-pane fade" id="addSalaryTab">
              <div class="row g-3">
                <div class="col-md-6"><label>Employee Salary (CTC)</label><input type="number" id="addAnnualCTC" name="ctc" class="form-control" required></div>
              </div>

              <!-- Earnings -->
              <h6 class="mt-3 fw-bold">Earnings</h6>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th>Component</th>
                      <th>Calculation Type %</th>
                      <th>Monthly</th>
                      <th>Annual</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Basic</td>
                      <td><input class="pct form-control" value="50" name="basic_percent"></td>
      
                      <td><input class="monthly form-control" readonly></td>
                      <td><input class="annual form-control" readonly></td>
                    </tr>
                    <tr>
                      <td>Fixed Allowance</td>
                      <td><input class="pct form-control" value="50" name="fixed_allowance"></td>
                      <td><input class="monthly form-control" readonly></td>
                      <td><input class="annual form-control" readonly></td>
                    </tr>
                    <tr>
                      <td>House Rent Allowance</td>
                      <td><input class="pct form-control" value="20" name="hra_percent"></td>
                      <td><input class="monthly form-control" readonly></td>
                      <td><input class="annual form-control" readonly></td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Reimbursements -->
              <h6 class="mt-3 fw-bold">Reimbursements</h6>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <tbody>
                    <tr>
                      <td>Medical Reimbursement</td>
                      <td><input class="pct form-control" value="10" name="medical_fixed"></td>
                      <td><input class="monthly form-control" readonly></td>
                      <td><input class="annual form-control" readonly></td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Flexible Benefits -->
              <h6 class="mt-3 fw-bold">Flexible Benefit Plan Components</h6>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <tbody>
                    <tr>
                      <td>Driver Reimbursement</td>
                      <td><input class="pct form-control" value="10" name="driver_reimbursement"></td>
                      <td><input class="monthly form-control" readonly></td>
                      <td><input class="annual form-control" readonly></td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Deductions -->
              <h6 class="mt-3 fw-bold">Deductions</h6>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <tbody>
                    <tr>
                      <td>EPF Contribution</td>
                      <td><input class="pct form-control" value="12" name="epf_percent"></td>
                      <td><input class="monthly form-control" readonly></td>
                      <td><input class="annual form-control" readonly></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!-- ===== COST TO COMPANY ===== -->
<div class="border p-3 rounded bg-light mt-3">
  <h6 class="fw-bold mb-2">Cost to Company</h6>

  <div class="row">
    <div class="col-md-6">
      Monthly: <strong class="ctc-monthly-text">0</strong>
    </div>
    <div class="col-md-6">
      Annual: <strong class="ctc-annual-text">0</strong>
    </div>
  </div>

  <!-- values sent to backend -->
  <input type="hidden" name="ctc_monthly" class="ctc-monthly">
  <input type="hidden" name="ctc_annual" class="ctc-annual">
</div>


              <div class="d-flex justify-content-between mt-3">
                <button type="button" class="btn btn-secondary" onclick="nextTab('addBasicTab')">← Back</button>
                <button type="button" class="btn btn-primary" onclick="nextTab('addAccountTab')">Save & Next →</button>
              </div>
            </div>

            <!-- ACCOUNT -->
            <div class="tab-pane fade" id="addAccountTab">
              <div class="row g-3">
                <div class="col-md-6"><label>Bank Name</label><input name="bank_name" class="form-control"></div>
                <div class="col-md-6"><label>Account Number</label><input name="account_number" class="form-control"></div>
                <div class="col-md-6"><label>IFSC</label><input name="ifsc_code" class="form-control"></div>
                <div class="col-md-6"><label>Account Holder</label><input name="account_holder_name" class="form-control"></div>
              </div>
              <div class="d-flex justify-content-between mt-3">
                <button type="button" class="btn btn-secondary" onclick="nextTab('addSalaryTab')">← Back</button>
                <button type="submit" class="btn btn-success">Save Employee</button>
              </div>
            </div>
     

          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ================= VIEW EMPLOYEE MODAL ================= -->
<div class="modal fade" id="viewEmployeeModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">View Employee</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <ul class="nav nav-tabs mb-3">
          <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#viewBasicTab">Basic Details</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#viewSalaryTab">Salary</button></li>
          <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#viewAccountTab">Account</button></li>
        </ul>

        <div class="tab-content">

          <!-- BASIC -->
          <div class="tab-pane fade show active" id="viewBasicTab">
            <div class="row g-3">
              <div class="col-md-6"><label>Employee Code</label><input class="form-control" id="viewEmpCode" readonly></div>
              <div class="col-md-6"><label>Email</label><input class="form-control" id="viewWorkEmail" readonly></div>
              <div class="col-md-6"><label>First Name</label><input class="form-control" id="viewFirstName" readonly></div>
              <div class="col-md-6"><label>Last Name</label><input class="form-control" id="viewLastName" readonly></div>
              <div class="col-md-6"><label>Phone</label><input class="form-control" id="viewPhone" readonly></div>
              <div class="col-md-6"><label>Department</label><input class="form-control" id="viewDepartment" readonly></div>
              <div class="col-md-6"><label>Job Title</label><input class="form-control" id="viewJobTitle" readonly></div>
              <div class="col-md-6"><label>Date of Joining</label><input class="form-control" id="viewDateJoining" readonly></div>
              <div class="col-md-6"><label>Role</label><input class="form-control" id="viewRole" readonly></div>
            </div>
          </div>

          <!-- SALARY -->
          <div class="tab-pane fade" id="viewSalaryTab">
            <div class="row g-3">
              <div class="col-md-6"><label>CTC</label><input class="form-control" id="viewCTC" readonly></div>
            </div>

            <!-- Earnings -->
            <h6 class="mt-3 fw-bold">Earnings</h6>
            <div class="table-responsive">
              <table class="table table-bordered" id="viewEarningsTable">
                <thead class="table-light">
                  <tr>
                    <th>Component</th>
                    <th>Calculation Type</th>
                    <th>Monthly</th>
                    <th>Annual</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Basic</td>
                    <td><input class="form-control" readonly id="viewBasicCalc"></td>
                    <td><input class="form-control" readonly id="viewBasicMonthly"></td>
                    <td><input class="form-control" readonly id="viewBasicAnnual"></td>
                  </tr>
                  <tr>
                    <td>Fixed Allowance</td>
                    <td><input class="form-control" readonly id="viewFixedAllowanceCalc"></td>
                    <td><input class="form-control" readonly id="viewFixedAllowanceMonthly"></td>
                    <td><input class="form-control" readonly id="viewFixedAllowanceAnnual"></td>
                  </tr>
                  <tr>
                    <td>HRA</td>
                    <td><input class="form-control" readonly id="viewHRAcalc"></td>
                    <td><input class="form-control" readonly id="viewHRAMonthly"></td>
                    <td><input class="form-control" readonly id="viewHRAAnnual"></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Reimbursements -->
            <h6 class="mt-3 fw-bold">Reimbursements</h6>
            <div class="table-responsive">
              <table class="table table-bordered">
                <tbody>
                  <tr>
                    <td>Medical Reimbursement</td>
                    <td><input class="form-control" readonly id="viewMedicalReim"></td>
                    <td><input class="form-control" readonly id="viewMedicalMonthly"></td>
                    <td><input class="form-control" readonly id="viewMedicalAnnual"></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Flexible Benefits -->
            <h6 class="mt-3 fw-bold">Flexible Benefit Plan Components</h6>
            <div class="table-responsive">
              <table class="table table-bordered">
                <tbody>
                  <tr>
                    <td>Driver Reimbursement</td>
                    <td><input class="form-control" readonly id="viewDriverReim"></td>
                    <td><input class="form-control" readonly id="viewDriverMonthly"></td>
                    <td><input class="form-control" readonly id="viewDriverAnnual"></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Deductions -->
            <h6 class="mt-3 fw-bold">Deductions</h6>
            <div class="table-responsive">
              <table class="table table-bordered">
                <tbody>
                  <tr>
                    <td>EPF Contribution</td>
                    <td><input class="form-control" readonly id="viewEPFcalc"></td>
                    <td><input class="form-control" readonly id="viewEPFMonthly"></td>
                    <td><input class="form-control" readonly id="viewEPFAnnual"></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- ACCOUNT -->
          <div class="tab-pane fade" id="viewAccountTab">
            <div class="row g-3">
              <div class="col-md-6"><label>Bank Name</label><input class="form-control" id="viewBankName" readonly></div>
              <div class="col-md-6"><label>Account Number</label><input class="form-control" id="viewAccountNumber" readonly></div>
              <div class="col-md-6"><label>IFSC</label><input class="form-control" id="viewIFSC" readonly></div>
              <div class="col-md-6"><label>Account Holder</label><input class="form-control" id="viewAccountHolder" readonly></div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>


<!-- ================= EDIT EMPLOYEE MODAL ================= -->
<div class="modal fade" id="editEmployeeModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <form id="editEmployeeForm" action="/admin/employees/edit" method="POST">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">Edit Employee</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul class="nav nav-tabs mb-3">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#editBasicTab">Basic Details</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#editSalaryTab">Salary</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#editAccountTab">Account</button></li>
          </ul>

          <div class="tab-content">

            <!-- BASIC DETAILS -->
            <div class="tab-pane fade show active" id="editBasicTab">
              <div class="row g-3">
                <input type="hidden" name="emp_id" id="editEmpId">
                <div class="col-md-6"><label>Employee Code</label><input name="emp_code" id="editEmpCode" class="form-control" required></div>
                <div class="col-md-6"><label>Email</label><input name="work_email" id="editWorkEmail" type="email" class="form-control" required></div>
                <div class="col-md-6"><label>First Name</label><input name="first_name" id="editFirstName" class="form-control" required></div>
                <div class="col-md-6"><label>Last Name</label><input name="last_name" id="editLastName" class="form-control" required></div>
                <div class="col-md-6"><label>Phone</label><input name="phone" id="editPhone" class="form-control"></div>
                <div class="col-md-6"><label>Department</label><input name="department" id="editDepartment" class="form-control"></div>
                <div class="col-md-6"><label>Job Title</label><input name="job_title" id="editJobTitle" class="form-control"></div>
                <div class="col-md-6"><label>Date of Joining</label><input name="date_of_joining" id="editDateJoining" type="date" class="form-control" required></div>
                <div class="col-md-6"><label>Role</label>
                  <select name="role_id" id="editRoleId" class="form-control">
                    <option value="1">Admin</option>
                    <option value="2">Manager</option>
                    <option value="3">Employee</option>
                  </select>
                </div>
                <div class="col-md-6">
  <label>Status</label>
  <select name="status" id="editStatus" class="form-control">
    <option value="Active">Active</option>
    <option value="Inactive">Inactive</option>
    <option value="Terminated">Terminated</option>
  </select>
</div>

              </div>
              <div class="text-end mt-3">
                <button type="button" class="btn btn-primary" onclick="nextTab('editSalaryTab')">Save & Next →</button>
              </div>
            </div>

            <!-- SALARY -->
            <div class="tab-pane fade" id="editSalaryTab">
              <div class="row g-3">
                <div class="col-md-6"><label>Employee Salary (CTC)</label><input type="number" id="editAnnualCTC" name="ctc" class="form-control" required></div>
              </div>

              <!-- Earnings -->
              <h6 class="mt-3 fw-bold">Earnings</h6>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th>Component</th>
                      <th>Calculation Type</th>
                      <th>Monthly</th>
                      <th>Annual</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Basic</td>
                      <td><input class="pct form-control" value="50" name="basic_percent"></td>
                      <td><input class="monthly form-control" readonly></td>
                      <td><input class="annual form-control" readonly></td>
                    </tr>
                    <tr>
                      <td>Fixed Allowance</td>
                      <td><input class="fixed form-control" value="4532" name="fixed_allowance"></td>
                      <td><input class="monthly form-control" readonly></td>
                      <td><input class="annual form-control" readonly></td>
                    </tr>
                    <tr>
                      <td>House Rent Allowance</td>
                      <td><input class="pct form-control" value="20" name="hra_percent"></td>
                      <td><input class="monthly form-control" readonly></td>
                      <td><input class="annual form-control" readonly></td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Reimbursements -->
              <h6 class="mt-3 fw-bold">Reimbursements</h6>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <tbody>
                    <tr>
                      <td>Medical Reimbursement</td>
                      <td><input class="fixed form-control" value="1000" name="medical_fixed"></td>
                      <td><input class="monthly form-control" readonly></td>
                      <td><input class="annual form-control" readonly></td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Flexible Benefits -->
              <h6 class="mt-3 fw-bold">Flexible Benefit Plan Components</h6>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <tbody>
                    <tr>
                      <td>Driver Reimbursement</td>
                      <td><input class="fixed form-control" value="1000" name="driver_reimbursement"></td>
                      <td><input class="monthly form-control" readonly></td>
                      <td><input class="annual form-control" readonly></td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Deductions -->
              <h6 class="mt-3 fw-bold">Deductions</h6>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <tbody>
                    <tr>
                      <td>EPF Contribution</td>
                      <td><input class="pct form-control" value="12" name="epf_percent"></td>
                      <td><input class="monthly form-control" readonly></td>
                      <td><input class="annual form-control" readonly></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!-- ===== COST TO COMPANY ===== -->
<div class="border p-3 rounded bg-light mt-3">
  <h6 class="fw-bold mb-2">Cost to Company</h6>

  <div class="row">
    <div class="col-md-6">
      Monthly: <strong class="ctc-monthly-text">0</strong>
    </div>
    <div class="col-md-6">
      Annual: <strong class="ctc-annual-text">0</strong>
    </div>
  </div>

  <input type="hidden" name="ctc_monthly" class="ctc-monthly">
  <input type="hidden" name="ctc_annual" class="ctc-annual">
</div>


              <div class="d-flex justify-content-between mt-3">
                <button type="button" class="btn btn-secondary" onclick="nextTab('editBasicTab')">← Back</button>
                <button type="button" class="btn btn-primary" onclick="nextTab('editAccountTab')">Save & Next →</button>
              </div>
            </div>

            <!-- ACCOUNT -->
            <div class="tab-pane fade" id="editAccountTab">
              <div class="row g-3">
                <div class="col-md-6"><label>Bank Name</label><input name="bank_name" id="editBankName" class="form-control"></div>
                <div class="col-md-6"><label>Account Number</label><input name="account_number" id="editAccountNumber" class="form-control"></div>
                <div class="col-md-6"><label>IFSC</label><input name="ifsc_code" id="editIFSC" class="form-control"></div>
                <div class="col-md-6"><label>Account Holder</label><input name="account_holder_name" id="editAccountHolder" class="form-control"></div>
              </div>
              <div class="d-flex justify-content-between mt-3">
                <button type="button" class="btn btn-secondary" onclick="nextTab('editSalaryTab')">← Back</button>
                <button type="submit" class="btn btn-success">Save Changes</button>
              </div>
            </div>

          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
/* ======================================================
   TAB NAVIGATION
====================================================== */
function nextTab(tabId) {
    const modal = document.querySelector('.modal.show');
    if (!modal) return;

    const btn = modal.querySelector(`button[data-bs-target="#${tabId}"]`);
    if (btn) bootstrap.Tab.getOrCreateInstance(btn).show();
}

/* ======================================================
   SALARY + CTC CALCULATION (ADD & EDIT)
====================================================== */
function updateSalaryTable(modal) {
    if (!modal || modal.id === 'viewEmployeeModal') return;

    const ctcInput = modal.querySelector('[name="ctc"]');
    if (!ctcInput) return;

    const ctc = parseFloat(ctcInput.value) || 0;
    let totalAnnual = 0;

    modal.querySelectorAll('table tbody tr').forEach(row => {
        const pctInput   = row.querySelector('.pct');
        const fixedInput = row.querySelector('.fixed');
        const monthlyEl  = row.querySelector('.monthly');
        const annualEl   = row.querySelector('.annual');

        let annual = 0;

        if (pctInput) {
            annual = (ctc * (parseFloat(pctInput.value) || 0)) / 100;
        } else if (fixedInput) {
            annual = (parseFloat(fixedInput.value) || 0) * 12;
        }

        if (monthlyEl) monthlyEl.value = annual ? (annual / 12).toFixed(2) : '';
        if (annualEl)  annualEl.value  = annual ? annual.toFixed(2) : '';

        totalAnnual += annual;
    });

    /* ===== COST TO COMPANY ===== */
    const ctcMonthly = Math.round(totalAnnual / 12);
    const ctcAnnual  = Math.round(totalAnnual);

    const monthlyText = modal.querySelector('.ctc-monthly-text');
    const annualText  = modal.querySelector('.ctc-annual-text');
    const monthlyInp  = modal.querySelector('.ctc-monthly');
    const annualInp   = modal.querySelector('.ctc-annual');

    if (monthlyText) monthlyText.innerText = ctcMonthly;
    if (annualText)  annualText.innerText  = ctcAnnual;
    if (monthlyInp)  monthlyInp.value      = ctcMonthly;
    if (annualInp)   annualInp.value       = ctcAnnual;
}

/* ======================================================
   LIVE SALARY UPDATE (NO BLINKING)
====================================================== */
document.addEventListener('input', e => {
    const modal = e.target.closest('#addEmployeeModal, #editEmployeeModal');
    if (!modal) return;

    if (
        e.target.classList.contains('pct') ||
        e.target.classList.contains('fixed') ||
        e.target.name === 'ctc'
    ) {
        updateSalaryTable(modal);
    }
});

/* ======================================================
   OPEN EDIT EMPLOYEE
====================================================== */
function openEditEmployee(empId) {
    fetch(`/admin/employees/view/${empId}`)
        .then(r => r.json())
        .then(emp => {

            editEmployeeForm.action = `/admin/employees/edit/${empId}`;

            editEmpId.value        = empId;
            editEmpCode.value      = emp.emp_code;
            editWorkEmail.value    = emp.work_email;
            editFirstName.value    = emp.first_name;
            editLastName.value     = emp.last_name;
            editPhone.value        = emp.phone || '';
            editDepartment.value   = emp.department || '';
            editJobTitle.value     = emp.job_title || '';
            editDateJoining.value  = emp.date_of_joining;
            editRoleId.value       = emp.role_id;
            editStatus.value       = emp.status || 'Active';

            /* Salary */
            editAnnualCTC.value = emp.salary?.gross_salary || 0;

            editEmployeeForm.querySelector('[name="basic_percent"]').value =
                emp.salary?.basic_percent ?? 50;
            editEmployeeForm.querySelector('[name="hra_percent"]').value =
                emp.salary?.hra_percent ?? 20;
            editEmployeeForm.querySelector('[name="fixed_allowance"]').value =
                emp.salary?.fixed_allowance ?? 4532;
            editEmployeeForm.querySelector('[name="medical_fixed"]').value =
                emp.salary?.medical_fixed ?? 1000;
            editEmployeeForm.querySelector('[name="driver_reimbursement"]').value =
                emp.salary?.driver_reimbursement ?? 1000;
            editEmployeeForm.querySelector('[name="epf_percent"]').value =
                emp.salary?.epf_percent ?? 12;

            /* Account */
            editBankName.value      = emp.account?.bank_name || '';
            editAccountNumber.value = emp.account?.account_number || '';
            editIFSC.value          = emp.account?.ifsc_code || '';
            editAccountHolder.value = emp.account?.account_holder_name || '';

            setTimeout(() => updateSalaryTable(editEmployeeModal), 200);
        })
        .catch(console.error);
}

/* ======================================================
   OPEN VIEW EMPLOYEE
====================================================== */
function openViewEmployee(empId) {
    fetch(`/admin/employees/view/${empId}`)
        .then(r => r.json())
        .then(emp => {

            viewEmpCode.value     = emp.emp_code;
            viewWorkEmail.value   = emp.work_email;
            viewFirstName.value   = emp.first_name;
            viewLastName.value    = emp.last_name;
            viewPhone.value       = emp.phone || '';
            viewDepartment.value  = emp.department || '';
            viewJobTitle.value    = emp.job_title || '';
            viewDateJoining.value = emp.date_of_joining;
            viewRole.value        = emp.role_name;

            const ctc = emp.salary?.gross_salary || 0;
            viewCTC.value = ctc;

            const calc = (pct) => (ctc * pct) / 100;

            const basicA = calc(emp.salary?.basic_percent || 0);
            const hraA   = calc(emp.salary?.hra_percent || 0);
            const epfA   = calc(emp.salary?.epf_percent || 0);

            viewBasicCalc.value   = emp.salary?.basic_percent + '%';
            viewBasicAnnual.value = basicA.toFixed(2);
            viewBasicMonthly.value= (basicA/12).toFixed(2);

            viewHRAcalc.value     = emp.salary?.hra_percent + '%';
            viewHRAAnnual.value   = hraA.toFixed(2);
            viewHRAMonthly.value  = (hraA/12).toFixed(2);

            viewFixedAllowanceCalc.value   = emp.salary?.fixed_allowance || 0;
            viewFixedAllowanceAnnual.value = (emp.salary?.fixed_allowance || 0) * 12;
            viewFixedAllowanceMonthly.value= emp.salary?.fixed_allowance || 0;

            viewMedicalReim.value   = emp.salary?.medical_fixed || 0;
            viewMedicalAnnual.value = (emp.salary?.medical_fixed || 0) * 12;
            viewMedicalMonthly.value= emp.salary?.medical_fixed || 0;

            viewDriverReim.value   = emp.salary?.driver_reimbursement || 0;
            viewDriverAnnual.value = (emp.salary?.driver_reimbursement || 0) * 12;
            viewDriverMonthly.value= emp.salary?.driver_reimbursement || 0;

            viewEPFcalc.value   = emp.salary?.epf_percent + '%';
            viewEPFAnnual.value = epfA.toFixed(2);
            viewEPFMonthly.value= (epfA/12).toFixed(2);

            viewBankName.value      = emp.account?.bank_name || '';
            viewAccountNumber.value = emp.account?.account_number || '';
            viewIFSC.value          = emp.account?.ifsc_code || '';
            viewAccountHolder.value = emp.account?.account_holder_name || '';
        })
        .catch(console.error);
}

/* ======================================================
   INITIAL CALC ON MODAL OPEN
====================================================== */
document.querySelectorAll('#addEmployeeModal, #editEmployeeModal')
    .forEach(m => m.addEventListener('shown.bs.modal', () => updateSalaryTable(m)));
</script>



{% endblock %}
