{% extends "manager/manager_base.html" %}

{% block content %}
<div class="container mt-4">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-primary">
      <i class="bi bi-people"></i> My Team
    </h2>
    <span id="liveClock" class="fs-5 fw-semibold badge bg-dark px-3 py-2"></span>
  </div>

  <!-- Team Attendance Table -->
  <div class="card shadow-sm mb-4 border-0">
    <div class="card-header bg-primary text-white">
      <strong><i class="bi bi-calendar-day"></i> Today's Attendance ({{ today.strftime("%d-%m-%Y") }})</strong>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle mb-0" id="teamTodayTable">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Clock In</th>
              <th>Clock Out</th>
              <th>Total Worked</th>
              <th>Status</th>
              <th>View</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="viewModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content shadow-lg border-0">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-person-badge"></i> <span id="modalTitle"></span></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="modalTopSummary" class="alert alert-info p-2 mb-3"></div>

        <ul class="nav nav-tabs" id="viewTabs" role="tablist">
          <li class="nav-item">
            <button class="nav-link active fw-bold" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions">
              <i class="bi bi-shuffle"></i> Transactions
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link fw-bold" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly">
              <i class="bi bi-calendar-month"></i> Monthly Summary
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link fw-bold" id="lastrecord-tab" data-bs-toggle="tab" data-bs-target="#lastrecord">
              <i class="bi bi-file-earmark-check"></i> Last Record
            </button>
          </li>
        </ul>

        <div class="tab-content mt-3">
          <!-- Transactions -->
          <div class="tab-pane fade show active" id="transactions">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <label class="fw-bold me-2">Date:</label>
                <input type="date" id="txnDate" class="form-control form-control-sm d-inline-block w-auto" />
              </div>
              <button class="btn btn-primary btn-sm fw-bold" id="refreshTxnBtn">
                <i class="bi bi-arrow-clockwise"></i> Refresh
              </button>
            </div>
            <div class="alert alert-primary py-2 mb-3">
              <strong>Total Worked Hours:</strong>
              <span id="day-total-worked" class="fw-bold">00:00:00</span>
            </div>
            <div class="table-responsive">
              <table class="table table-bordered table-hover text-center" id="txnTable">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Clock In</th>
                    <th>Clock Out</th>
                    <th>Duration</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- Monthly -->
          <div class="tab-pane fade" id="monthly">
            <div class="mb-3">
              <label class="fw-bold me-2">Choose Month:</label>
              <input type="month" id="monthSelect" class="form-control form-control-sm d-inline-block w-auto" />
              <button class="btn btn-primary btn-sm fw-bold ms-2" id="loadMonthBtn">
                <i class="bi bi-search"></i> Load
              </button>
            </div>
            <div id="monthlySummary"></div>
          </div>

          <!-- Last Record -->
          <div class="tab-pane fade" id="lastrecord">
            <div id="lastRecordBlock" class="p-3 border rounded bg-light"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
table.table tbody tr:hover { background-color: #1075d9; transition: 0.2s; }
.card { border-radius: 10px; }
</style>

<script>
/* LIVE CLOCK */
function startClock() {
  const clockEl = document.getElementById('liveClock');
  function update() {
    clockEl.innerText = new Date().toLocaleTimeString();
  }
  update();
  setInterval(update, 1000);
}

/* CREATE TABLE CELL */
function createCell(text) { const td = document.createElement('td'); td.innerText = text ?? '-'; return td; }

/* LOAD TEAM TODAY TABLE */
async function loadTeamToday() {
  try {
    const res = await fetch("/manager/team/list_today");
    const data = await res.json();
    const tbody = document.querySelector("#teamTodayTable tbody");
    tbody.innerHTML = "";

    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.appendChild(createCell(row.name));
      tr.appendChild(createCell(row.clock_in));
      tr.appendChild(createCell(row.clock_out));
      tr.appendChild(createCell(row.worked));
      tr.appendChild(createCell(row.status));

      const btnTd = document.createElement('td');
      const btn = document.createElement('button');
      btn.className = "btn btn-sm btn-primary";
      btn.innerText = "View";
      btn.onclick = () => openViewModal(row.user_id, row.date, row.name);
      btnTd.appendChild(btn);
      tr.appendChild(btnTd);

      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error("Failed to load team today", err);
  }
}

/* MODAL & TAB LOGIC */
let currentModalUserId = null;
let currentModalUserName = null;

function openViewModal(userId, dateStr=null, userName=null) {
  currentModalUserId = userId;
  currentModalUserName = userName;
  document.getElementById('modalTitle').innerText = "Attendance Details - " + (currentModalUserName ?? ("User #" + userId));
  document.getElementById('txnDate').value = dateStr ?? new Date().toISOString().slice(0,10);
  document.getElementById('monthSelect').value = new Date().toISOString().slice(0,7);
  loadTransactions();
  new bootstrap.Modal(document.getElementById('viewModal')).show();
}

document.getElementById('refreshTxnBtn')?.addEventListener('click', loadTransactions);
document.getElementById('txnDate')?.addEventListener('change', loadTransactions);
document.getElementById('loadMonthBtn')?.addEventListener('click', loadMonthly);

async function loadTransactions() {
  if (!currentModalUserId) return;
  const dateVal = document.getElementById('txnDate').value;

  try {
    const res = await fetch(`/manager/team/attendance/${currentModalUserId}?date=${dateVal}`);
    const json = await res.json();

    const tbody = document.querySelector("#txnTable tbody");
    tbody.innerHTML = "";
    json.transactions?.forEach((tx, i) => {
      const tr = document.createElement('tr');
      tr.appendChild(createCell(i+1));
      tr.appendChild(createCell(tx.clock_in));
      tr.appendChild(createCell(tx.clock_out));
      tr.appendChild(createCell(tx.duration));
      tbody.appendChild(tr);
    });

    document.getElementById('modalTopSummary').innerHTML = `<div><strong>Date:</strong> ${dateVal} - ${currentModalUserName}</div>`;
    document.getElementById('day-total-worked').innerText = json.last_record?.worked ?? "00:00:00";

    document.getElementById('lastRecordBlock').innerHTML = json.last_record ? `
      <div class="border p-2">
        <div><strong>Last Record</strong></div>
        <div>Clock In: ${json.last_record.clock_in}</div>
        <div>Clock Out: ${json.last_record.clock_out}</div>
        <div>Worked: ${json.last_record.worked}</div>
        <div>Status: ${json.last_record.status}</div>
      </div>` : `<div class="text-muted">No records for this date</div>`;
  } catch(err) {
    console.error("Error loading transactions", err);
    document.querySelector("#txnTable tbody").innerHTML = `<tr><td colspan="4">Failed to load</td></tr>`;
    document.getElementById('modalTopSummary').innerHTML = `<div class="text-danger">Error loading data</div>`;
    document.getElementById('day-total-worked').innerText = "00:00:00";
    document.getElementById('lastRecordBlock').innerHTML = `<div class="text-muted">No records for this date</div>`;
  }
}

async function loadMonthly() {
  if (!currentModalUserId) return;
  const monthVal = document.getElementById('monthSelect').value;
  if (!monthVal) return alert("Select month");
  const [y,m] = monthVal.split('-');
  try {
    const res = await fetch(`/manager/team/monthly/${currentModalUserId}/${y}/${m}`);
    const json = await res.json();
    if (json.error) { document.getElementById('monthlySummary').innerHTML = `<div class="text-danger">${json.error}</div>`; return; }

    document.getElementById('monthlySummary').innerHTML = `
      <div class="border p-3">
        <div><strong>Month:</strong> ${y}-${m}</div>
        <div><strong>Present Days:</strong> ${json.present_days}</div>
        <div><strong>Absent Days:</strong> ${json.absent_days}</div>
        <div><strong>Total Worked:</strong> ${json.total_worked}</div>
        <div><strong>Late Days:</strong> ${json.late_days}</div>
        <div><strong>Early Leaves:</strong> ${json.early_leaves}</div>
      </div>`;
  } catch(err){ console.error("Failed monthly",err); document.getElementById('monthlySummary').innerHTML = `<div class="text-danger">Error loading monthly summary</div>`;}
}

/* INIT */
startClock();
loadTeamToday();
setInterval(loadTeamToday, 30000);
</script>
{% endblock %}
